# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Code Coverage

on:
    pull_request:
        branches: [main, development, feat/**]

jobs:
    build:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [20.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
                redis-version: [6]

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v5
              with:
                  node-version: ${{ matrix.node-version }}

            - name: Setup Redis Server in GitHub Actions
              uses: supercharge/redis-github-action@1.2.0
              with:
                  redis-version: ${{ matrix.redis-version }}

            - run: npm ci
            - run: npm run build --if-present
            - run: npm run test:cov

            - name: Upload code coverage
              uses: codecov/codecov-action@v5
              with:
                  files: ./coverage/unit/clover.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: true
                  verbose: true
